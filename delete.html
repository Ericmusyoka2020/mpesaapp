
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title></title>
<style>
* { box-sizing: border-box; }
body { 
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
  background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #0f0f0f 100%); 
  margin: 0; padding: 20px; min-height: 100vh; 
  color: #e0e0e0;
}
.container { 
  max-width: 500px; width: 100%; background: #2a2a2a; 
  margin: 0 auto; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.5);
  overflow: hidden; border: 1px solid #111111;
}
.content { padding: 30px 25px; }
h2 { text-align: center; color: #ffffff; margin: 0 0 30px; font-size: 24px; font-weight: 600; }
.step-label {
  display: none !important;
  margin: 20px 0 8px; font-weight: 600; color: #cccccc; font-size: 16px;
  text-align: center; padding: 8px 0;
}
.step-label.active { display: block !important; }
input, button { 
  width: 100%; padding: 16px 20px; margin-bottom: 10px; border-radius: 12px; 
  font-size: 18px; transition: all 0.3s ease; display: none;
  background: #111111; color: #ffffff; border: 2px solid #505050;
}
input.active, button.active { display: block; }
input::placeholder { color: #0f0f0f; }
input:focus { 
  outline: none; border-color: #121213; box-shadow: 0 0 0 3px rgba(5, 5, 5, 0.2);
  background: #141414;
}
button { 
  background: #000000; color: #ffffff; 
  border: 2px solid #070707; cursor: pointer; font-weight: 600; font-size: 18px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.6);
}
button:hover:not(:disabled), button:active:not(:disabled) { 
  background: #1a1a1a; transform: translateY(-2px); 
  box-shadow: 0 6px 20px rgba(0,0,0,0.8); border-color: #0a0a0a;
}
button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

.radio-group { 
  display: none; margin: 20px 0; padding: 20px; 
  background: #0c0c0c; border-radius: 12px; border: 1px solid #0f0f0f;
}
.radio-group.active { display: block; }
.radio-group label { 
  display: block; margin: 10px 0; padding: 16px 20px; 
  border: 2px solid #0c0c0c; border-radius: 12px; 
  background: #080808; color: #e0e0e0; cursor: pointer; transition: all 0.3s ease;
  font-size: 16px; font-weight: 500;
}
.radio-group input { display: none; }
.radio-group label.selected, .radio-group label:hover { 
  background: #000000; color: #ffffff; border-color: #0f0f0f;
}

pre { 
  background: #1e1e1e; padding: 20px; border-radius: 12px; margin-top: 20px; 
  white-space: pre-wrap; font-family: 'Courier New', monospace; 
  font-size: 14px; line-height: 1.5; color: #141414;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); border: 1px solid #333;
}

@media (max-width: 480px) {
  body { padding: 15px; }
  .content { padding: 25px 20px; }
  input, button { padding: 18px 16px; font-size: 17px; }
  h2 { font-size: 22px; }
}
@media (max-height: 600px) {
  .content { padding: 20px 20px; }
  .step-label { margin: 15px 0 6px; }
}
</style>
</head>
<body>
<div class="container">
  <div class="content">
    <h2></h2>

    <!-- Step 1: Till Number (SAVED as 'phone') -->
    <div class="step-label active" id="phoneLabel">Enter business no</div>
    <input type="tel" id="phone" placeholder="" class="active">
    <button id="phoneOkBtn" class="active">OK</button>

    <!-- Step 2: Account Number (1+ digits allowed, NOT saved) -->
    <div class="step-label" id="accountLabel">Enter Account Number</div>
    <input type="tel" id="accountNo" placeholder="">
    <button id="accountOkBtn">OK</button>

    <!-- Step 3: Amount -->
    <div class="step-label" id="amountLabel">Enter Amount</div>
    <input type="number" id="amount" placeholder="" step="0.01">
    <button id="amountOkBtn">OK</button>

    <!-- Step 4: Name -->
    <div class="step-label" id="nameLabel">Enter Account Name</div>
    <input type="text" id="name" placeholder="Enter account holder name">
    <button id="nameOkBtn">OK</button>

    <!-- Step 5: Till Confirmation -->
    <div class="radio-group" id="phoneOptionContainer">
      <div class="step-label" id="confirmLabel"></div>
      <label id="pochiLabel" class="selected">
        <input type="radio" name="includePhone" value="pochi" checked> 
        Sending to Till Number
      </label>
    </div>

    <!-- Step 6: Send -->
    <button id="sendBtn">Send Money</button>

    <pre id="output"></pre>
  </div>
</div>

<script>
const API = "https://mpesa-1-mc8e.onrender.com";

const elements = {
  phone: { 
    input: document.getElementById("phone"), 
    btn: document.getElementById("phoneOkBtn"), 
    label: document.getElementById("phoneLabel") 
  },
  accountNo: {
    input: document.getElementById("accountNo"),
    btn: document.getElementById("accountOkBtn"),
    label: document.getElementById("accountLabel")
  },
  amount: { 
    input: document.getElementById("amount"), 
    btn: document.getElementById("amountOkBtn"), 
    label: document.getElementById("amountLabel") 
  },
  name: { 
    input: document.getElementById("name"), 
    btn: document.getElementById("nameOkBtn"), 
    label: document.getElementById("nameLabel") 
  },
  options: document.getElementById("phoneOptionContainer"),
  confirmLabel: document.getElementById("confirmLabel"),
  send: document.getElementById("sendBtn"),
  output: document.getElementById("output")
};

const pochiLabel = document.getElementById("pochiLabel");

/* ================= HELPERS ================= */
function calculateCost(amount) {
  return amount > 100 ? 5.00 : 0;
}

function generateUAToken() {
  const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let token="TL";
  for(let i=0;i<8;i++) token+=chars[Math.floor(Math.random()*chars.length)];
  return token;
}

function randomBalance(){ return (Math.random()*5000+100).toFixed(2);}
function formatDateTime(){
  const d = new Date();
  const day = String(d.getDate()).padStart(2, '0');
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const year = String(d.getFullYear()).slice(-2);
  const time = d.toLocaleTimeString([], {hour: 'numeric', minute:'2-digit', hour12: true});
  return `${day}/${month}/${year} at ${time}`;
}

function showStep(step) {
  document.querySelectorAll('.step-label').forEach(label => {
    label.classList.remove('active');
  });
  
  Object.values(elements).forEach(el => {
    if (typeof el === 'object' && el.input) el.input.classList.remove('active');
    if (typeof el === 'object' && el.btn) el.btn.classList.remove('active');
    if (el === elements.options || el === elements.send) el.classList.remove('active');
  });
  
  if (step === 'phone') {
    elements.phone.input.classList.add('active');
    elements.phone.btn.classList.add('active');
    elements.phone.label.classList.add('active');
    elements.phone.input.focus();
  } else if (step === 'account') {
    elements.accountNo.input.classList.add('active');
    elements.accountNo.btn.classList.add('active');
    elements.accountNo.label.classList.add('active');
    elements.accountNo.input.focus();
  } else if (step === 'amount') {
    elements.amount.input.classList.add('active');
    elements.amount.btn.classList.add('active');
    elements.amount.label.classList.add('active');
    elements.amount.input.focus();
  } else if (step === 'name') {
    elements.name.input.classList.add('active');
    elements.name.btn.classList.add('active');
    elements.name.label.classList.add('active');
    elements.name.input.focus();
  } else if (step === 'options') {
    elements.options.classList.add('active');
    elements.send.classList.add('active');
  }
}

function resetForm() {
  elements.phone.input.value = "";
  elements.accountNo.input.value = "";
  elements.amount.input.value = "";
  elements.name.input.value = "";
  elements.output.textContent = "";
  elements.confirmLabel.textContent = "";
  showStep('phone');
}

// Initialize first step
showStep('phone');

/* ================= STEP EVENT LISTENERS ================= */
elements.phone.btn.addEventListener("click", async ()=>{
  const tillNo = elements.phone.input.value.trim();
  if(!tillNo || tillNo.length < 6) return alert("Enter valid till number (6+ digits)");
  showStep('account');
});

// ✅ CHANGED: Account number can be 1+ digits (not 7+)
elements.accountNo.btn.addEventListener("click", ()=>{
  const accountNo = elements.accountNo.input.value.trim();
  if(!accountNo || accountNo.length < 1) return alert("Enter account number (1+ digits)");
  showStep('amount');
});

elements.amount.btn.addEventListener("click", ()=>{
  const amount = parseFloat(elements.amount.input.value);
  if(!amount || amount <= 0 || amount > 50000) return alert("Enter valid amount (1-50,000)");
  showStep('name');
});

elements.name.btn.addEventListener("click", ()=>{
  if(!elements.name.input.value.trim()) return alert("Enter account holder name");
  
  const tillNo = elements.phone.input.value.trim();
  const accountNo = elements.accountNo.input.value.trim();
  elements.confirmLabel.textContent = `Confirm: Sending to Till ${tillNo} for account ${accountNo}`;
  
  showStep('options');
});

/* ================= TILL CONFIRMATION ================= */
pochiLabel.addEventListener("click", () => {
  pochiLabel.classList.add("selected");
});

/* ================= SEND ================= */
elements.send.addEventListener("click", async ()=>{
  const tillNo = elements.phone.input.value.trim();
  const accountNo = elements.accountNo.input.value.trim();
  const amount = parseFloat(elements.amount.input.value);
  const name = elements.name.input.value.trim();
  
  if(!tillNo || !accountNo || !amount || amount <=0 || !name) {
    return alert("Complete all fields");
  }

  elements.send.disabled = true;
  elements.send.textContent = "Sending...";

  try {
    const cost = calculateCost(amount);
    const token = generateUAToken();
    const balance = randomBalance();
    const datetime = formatDateTime();

    const message = `${token} Confirmed. Ksh${amount.toFixed(2)} sent to ${name} for account ${accountNo} on ${datetime} New M-PESA balance is Ksh${balance}. Transaction cost, Ksh${cost.toFixed(2)}.Amount you can transact within the day is 499,960.00. Save frequent paybills for quick payment on M-PESA app https://bit.ly/mpesalnk `;

    // ✅ Backend-compatible payload
    const payload = { 
      phone: tillNo,
      name: name,
      amount: amount,
      cost: cost,
      message: message,
      token: token,
      type: "till"
    };
    
    const res = await fetch(`${API}/send`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    
    if(data.error) throw new Error(data.error);
    
    elements.output.textContent = message;
    setTimeout(resetForm, 2000);
  } catch(error) {
    alert(error.message || "Transaction failed");
  } finally {
    elements.send.disabled = false;
    elements.send.textContent = "Send Money";
  }
});
</script>
</body>
</html>
