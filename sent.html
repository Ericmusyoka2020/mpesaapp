
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title></title>
<style>
* { box-sizing: border-box; }

body { 
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; 
  background: #121212; 
  color: #e0e0e0; 
  margin: 0; 
  padding: 20px;
  min-height: 100vh;
}

.container { 
  max-width: 450px; 
  width: 100%; 
  background: #1e1e1e; 
  margin: 0 auto; 
  padding: 25px; 
  border-radius: 12px; 
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
}

.step-label {
  display: none !important; /* Initially hidden */
  margin-top: 15px;
  font-weight: 600;
  color: #b0b0b0;
  text-align: center;
  padding: 8px 0;
}

.step-label.active { /* Show when active */
  display: block !important;
}

input, button { 
  width: 100%; 
  padding: 12px 16px; 
  margin-top: 8px; 
  border: none; 
  border-radius: 8px; 
  font-size: 16px;
  display: none;
}

input.active, button.active { 
  display: block; 
}

input { 
  background: #2a2a2a; 
  color: #e0e0e0; 
  border: 1px solid #404040;
}

input::placeholder {
  color: #888;
}

input:focus {
  outline: none;
  border-color: #4caf50;
  box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
}

button { 
  background: linear-gradient(135deg, #080808, #0d0e0d); 
  color: white; 
  font-weight: 600; 
  cursor: pointer; 
  transition: all 0.2s ease;
}

button:hover { 
  background: linear-gradient(135deg, #45a049, #388e3c);
  transform: translateY(-1px);
}

button:active {
  transform: translateY(0);
}

pre { 
  background: #252525; 
  color: #e8eaf6; 
  padding: 16px; 
  border-radius: 8px; 
  margin-top: 15px; 
  white-space: pre-wrap; 
  font-size: 14px;
  line-height: 1.5;
  border-left: 4px solid #0d0e0d;
}

.radio-group { 
  display: none; 
  margin-top: 20px; 
}

.radio-group.active { 
  display: block; 
}

.radio-group label { 
  display: block; 
  margin: 8px 0; 
  cursor: pointer; 
  padding: 12px 16px; 
  border: 2px solid #404040; 
  border-radius: 8px; 
  background: #2a2a2a; 
  transition: all 0.2s ease;
  font-weight: 500;
}

.radio-group label:hover {
  border-color: #111111;
  background: #303030;
}

.radio-group input { 
  display: none; 
}

.radio-group label.selected { 
  background: linear-gradient(135deg, #111111, #121312); 
  color: white; 
  border-color: #121312;
}

@media (max-width: 480px) {
  body { padding: 15px; }
  .container { padding: 20px; margin: 10px auto; border-radius: 16px; }
  input, button { padding: 14px 16px; font-size: 17px; }
}
</style>
</head>
<body>
<div class="container">

<!-- Step 1: Phone -->
<div class="step-label active" id="phoneLabel">Enter phone no.</div>
<input type="text" id="phone" class="active">
<button id="phoneOkBtn" class="active">OK</button>

<!-- Step 2: Amount -->
<div class="step-label" id="amountLabel">Enter Amount</div>
<input type="number" id="amount" placeholder=" " step="0.01">
<button id="amountOkBtn">OK</button>

<!-- Step 3: Name -->
<div class="step-label" id="nameLabel">Enter Full Name</div>
<input type="text" id="name" placeholder="Enter full name">
<button id="nameOkBtn">OK</button>

<!-- Step 4: Radio Options -->
<div class="radio-group" id="phoneOptionContainer">
  <div class="step-label">Choose message format:</div>
  <label id="sendmoneyLabel"><input type="radio" name="includePhone" value="sendmoney"> Sendmoney (includes phone)</label>
  <label id="pochiLabel"><input type="radio" name="includePhone" value="pochi" checked> Pochi (name only)</label>
</div>

<!-- Step 5: Send -->
<button id="sendBtn">Send Message</button>

<pre id="output"></pre>
</div>

<script>
const API = "https://mpesab.vercel.app";

const elements = {
  phone: { input: document.getElementById("phone"), btn: document.getElementById("phoneOkBtn"), label: document.getElementById("phoneLabel") },
  amount: { input: document.getElementById("amount"), btn: document.getElementById("amountOkBtn"), label: document.getElementById("amountLabel") },
  name: { input: document.getElementById("name"), btn: document.getElementById("nameOkBtn"), label: document.getElementById("nameLabel") },
  options: document.getElementById("phoneOptionContainer"),
  send: document.getElementById("sendBtn"),
  output: document.getElementById("output")
};

const sendmoneyLabel = document.getElementById("sendmoneyLabel");
const pochiLabel = document.getElementById("pochiLabel");

function calculateCost(amount) {
  if(amount >= 1 && amount <= 100) return 0;
  else if(amount >= 101 && amount <= 500) return 7;
  else if(amount >= 501 && amount <= 1000) return 13;
  else if(amount >= 1001 && amount <= 20000) return 50;
  else if(amount >= 20001 && amount <= 35000) return 108;
  else if(amount >= 35001 && amount <= 50000) return 150;
  else if(amount >= 50001 && amount <= 250000) return 108;
  else return 113;
}

function generateUAToken() {
  const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let token="UA";
  for(let i=0;i<8;i++) token+=chars[Math.floor(Math.random()*chars.length)];
  return token;
}

function randomBalance(){ return (Math.random()*5000+100).toFixed(2);}
function formatDateTime(){
  const d=new Date();
  return `${d.getDate()}/${d.getMonth()+1}/${String(d.getFullYear()).slice(-2)} at `
       + d.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'});
}

function showStep(step) {
  // Hide ALL labels first
  document.querySelectorAll('.step-label').forEach(label => {
    label.classList.remove('active');
  });
  
  // Hide all inputs/buttons
  Object.values(elements).forEach(el => {
    if (typeof el === 'object' && el.input) el.input.classList.remove('active');
    if (typeof el === 'object' && el.btn) el.btn.classList.remove('active');
    if (el === elements.options || el === elements.send) el.classList.remove('active');
  });
  
  // Show ONLY current step
  if (step === 'phone') {
    elements.phone.input.classList.add('active');
    elements.phone.btn.classList.add('active');
    elements.phone.label.classList.add('active');
    elements.phone.input.focus();
  } else if (step === 'amount') {
    elements.amount.input.classList.add('active');
    elements.amount.btn.classList.add('active');
    elements.amount.label.classList.add('active');
    elements.amount.input.focus();
  } else if (step === 'name') {
    elements.name.input.classList.add('active');
    elements.name.btn.classList.add('active');
    elements.name.label.classList.add('active');
    elements.name.input.focus();
  } else if (step === 'options') {
    elements.options.classList.add('active');
    elements.send.classList.add('active');
  }
}

function resetForm() {
  showStep('phone');
}

// Initialize first step
showStep('phone');

/* ================= STEP EVENT LISTENERS ================= */
elements.phone.btn.addEventListener("click", async ()=>{
  const phone = elements.phone.input.value.trim();
  if(!phone) return alert("Please enter phone number");
  
  try {
    const res = await fetch(`${API}/lookup/${phone}`);
    const data = await res.json();
    elements.name.input.value = data.found ? data.name : "";
  } catch(e) {
    console.log("Lookup failed:", e);
  }
  
  showStep('amount');
});

elements.amount.btn.addEventListener("click", ()=>{
  const amount = parseFloat(elements.amount.input.value);
  if(!amount || amount <= 0) return alert("Please enter valid amount");
  showStep('name');
});

elements.name.btn.addEventListener("click", ()=>{
  if(!elements.name.input.value.trim()) return alert("Please enter full name");
  showStep('options');
});

/* ================= RADIO OPTIONS ================= */
function highlightOption() {
  if(document.querySelector('input[name="includePhone"]:checked').value === "sendmoney") {
    sendmoneyLabel.classList.add("selected");
    pochiLabel.classList.remove("selected");
  } else {
    pochiLabel.classList.add("selected");
    sendmoneyLabel.classList.remove("selected");
  }
}

sendmoneyLabel.addEventListener("click", ()=>{ 
  sendmoneyLabel.querySelector("input").checked = true; 
  highlightOption(); 
});
pochiLabel.addEventListener("click", ()=>{ 
  pochiLabel.querySelector("input").checked = true; 
  highlightOption(); 
});

highlightOption();

/* ================= SEND ================= */
elements.send.addEventListener("click", async ()=>{
  const phone = elements.phone.input.value.trim();
  const amount = parseFloat(elements.amount.input.value);
  const name = elements.name.input.value.trim();
  
  if(!phone || !amount || amount <=0 || !name) {
    return alert("Complete all fields");
  }

  const cost = calculateCost(amount);
  const token = generateUAToken();
  const balance = randomBalance();
  const datetime = formatDateTime();

  const selectedOption = document.querySelector('input[name="includePhone"]:checked').value;
  let message = `${token} Confirmed. Ksh${amount.toFixed(2)} sent to ${name}`;
  if(selectedOption === "sendmoney") message += ` ${phone}`;
  message += ` on ${datetime}. New Mpesa balance is Ksh${balance}. Transaction cost, Ksh${cost.toFixed(2)}. Amount you can transact within the day is 499,960.00.Sign up for Lipa Na M-PESA Till online https://m-pesaforbusiness.co.ke `;

  const payload = { phone, name, amount, cost, message, token };
  try {
    const res = await fetch(`${API}/send`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(data.error) return alert(data.error);
    
    elements.output.textContent = message;
    resetForm();
  } catch(e) {
    alert("Send failed");
  }
});
</script>
</body>
</html>
